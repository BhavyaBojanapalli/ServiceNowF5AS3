<?xml version="1.0" encoding="UTF-8"?>
<record_update sys_domain="global" table="sysevent_script_action">
    <sysevent_script_action action="INSERT_OR_UPDATE">
        <active>true</active>
        <condition_script/>
        <description/>
        <event_name>x_209235_f5_as3.AS3Change</event_name>
        <name>AS3ApiAction</name>
        <order>100</order>
        <script><![CDATA[gs.info("EVENT ACTION FIRED");

var f5App = new f5AppHelper();
var as3 = new AS3ApiUtils();

var appData = JSON.parse(current.app_data);
var cluster = f5App.getCluster(appData.dsc);
var deviceList = f5App.getDevicesByCluster(appData.dsc);

var result = {};
try {
	if (cluster.cluster_change_method == "active_no_snyc" ||
	    cluster.cluster_change_method == "active_snyc") {
		var activeDevice = as3.getActiveDevice(deviceList, cluster.mid_server);
		
		var response = as3.pushChange(
			activeDevice,
			cluster.mid_server,
			current.pending_action,
			current.as3_declaration
		);
		//result[activeDevice.mgmt_ip] = response;
	}
	
	// Implement record modification once changes are complete 
	var gr = new GlideRecord(f5App.applicationTable);
	gr.addQuery('number', current.number);		
	gr.query();
	gr.next();
	//gr.api_response = JSON.stringify(result);
	
	if (gr.pending_action == "create" || gr.pending_action == "update") {	
		gr.status = "deployed";
		gr.pending_action = "none";
		gr.update();
	} else if (gr.pending_action == "delete") {
		gr.deleteRecord();
	}
	
	
} catch(err) {
	gs.info("SCRIPT ACTION ERROR " + err);
}]]></script>
        <synchronous>false</synchronous>
        <sys_class_name>sysevent_script_action</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-11-08 01:28:41</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>df6342873765230040a1ae7873990e98</sys_id>
        <sys_mod_count>24</sys_mod_count>
        <sys_name>AS3ApiAction</sys_name>
        <sys_overrides/>
        <sys_package display_value="F5_AS3" source="x_209235_f5_as3">00ecd5513701230040a1ae7873990e4e</sys_package>
        <sys_policy/>
        <sys_scope display_value="F5_AS3">00ecd5513701230040a1ae7873990e4e</sys_scope>
        <sys_update_name>sysevent_script_action_df6342873765230040a1ae7873990e98</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-11-09 02:29:53</sys_updated_on>
    </sysevent_script_action>
</record_update>
